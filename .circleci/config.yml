version: 2.1

executors:
  default-executor:
    docker:
      - image: cimg/openjdk:21.0-browsers

jobs:
  build-frontend:
    executor: default-executor
    working_directory: ~/github-statistics
    steps:
      - checkout
      - restore_cache:
          keys:
            - frontend-{{ checksum "package-lock.json" }}
      - run:
          name: Install deps
          command:
            cd frontend |
            npm ci
#      - run:
#          name: Ng Lint
#          command: npm run lint
      - save_cache:
          paths:
            - ~/github-statistics/frontend/node_modules
          key: frontend-{{ checksum "package-lock.json" }}
      - run:
          name: Build
          command:
            cd frontend |
            mvn clean install
      - persist_to_workspace:
          root: ~/github-statistics
          paths:
            - frontend/target/*.jar
  build-backend:
    executor: default-executor
    working_directory: ~/github-statistics
    steps:
      - checkout
      - restore_cache:
          keys:
            - backend-{{ checksum "pom.xml" }}
#      - run:
#          name: Spotless check
#          command: mvn spotless:check
      - run:
          name: Build
          command:
            cd backend |
            mvn clean install
      - save_cache:
          paths:
            - ~/.m2
          key: backend-{{ checksum "pom.xml" }}
      - persist_to_workspace:
          root: ~/github-statistics
          paths:
            - backend/target/*.jar
  delivery:
    executor: default-executor
    working_directory: ~/github-statistics
    steps:
      - checkout
      - attach_workspace:
          at: ~/github-statistics
      - run:
          name: Install frontend JAR to local Maven repository
          command:
            mvn install:install-file \
              -Dfile=frontend/target/frontend-1.0-SNAPSHOT.jar \
              -DgroupId=dev.graczykmateusz \
              -DartifactId=frontend \
              -Dversion=1.0-SNAPSHOT \
              -Dpackaging=jar \
              -DgeneratePom=true
      - run:
          name: Install backend JAR to local Maven repository
          command:
            mvn install:install-file \
              -Dfile=backend/target/backend-1.0-SNAPSHOT.jar \
              -DgroupId=dev.graczykmateusz \
              -DartifactId=backend \
              -Dversion=1.0-SNAPSHOT \
              -Dpackaging=jar \
              -DgeneratePom=true
      - run:
          name: Build
          command:
            cd delivery |
            mvn package
      - persist_to_workspace:
          root: ~/github-statistics
          paths:
            - delivery/target/*.jar
  e2e:
    executor: default-executor
    working_directory: ~/github-statistics
    steps:
      - checkout
      - attach_workspace:
          at: ~/github-statistics
      - setup_remote_docker
      - run:
          name: Run Docker Compose
          command: |
            docker-compose up -d
      - run:
          name: Test
          command:
            cd e2e |
            mvn verify

workflows:
  main:
    jobs:
      - build-frontend:
          filters:
            branches:
              only: master
      - build-backend:
          filters:
            branches:
              only: master
      - delivery:
          requires:
            - build-frontend
            - build-backend
          filters:
            branches:
              only: master
      - e2e:
          requires:
            - delivery
          filters:
            branches:
              only: master